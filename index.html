<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Puzzeltocht Maastricht</title>

  <!-- Thema voor browser en PWA -->
  <meta name="theme-color" content="#000000" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Code Maastricht" />

  <!-- App iconen -->
  <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png" />
  <link rel="apple-touch-icon" sizes="192x192" href="/icon-192.png" />
  <link rel="apple-touch-icon" sizes="512x512" href="/icon-512.png" />

  <!-- Dynamisch manifest op basis van URL -->
  <script>
    const params = new URLSearchParams(location.search);
    const view = params.get("view");
    const team = params.get("team");

    let manifest = "/manifest-edit.json";
    if (view === "display" && team === "37xskp") manifest = "/manifest-team1.json";
    if (view === "display" && team === "z8kd01") manifest = "/manifest-team2.json";

    const link = document.createElement("link");
    link.rel = "manifest";
    link.href = manifest;
    document.head.appendChild(link);
  </script>

  <!-- ‚úÖ OneSignal v16 SDK -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(function (OneSignal) {
      const urlParams = new URLSearchParams(location.search);
      const view = urlParams.get("view");
      const team = urlParams.get("team");

  OneSignal.init({
  appId: "0c55e75a-a7cc-4829-8359-3171d4f456d0",
  language: "nl", // üëà forceer Nederlands
  notifyButton: {
    enable: true,
    size: 'medium',
    theme: 'default',
    text: {
      'tip.state.unsubscribed': "Meldingen inschakelen",
      'tip.state.subscribed': "Je ontvangt meldingen",
      'tip.state.blocked': "Meldingen geblokkeerd",
      'message.prenotify': "Klik om meldingen in te schakelen",
      'message.action.subscribed': "Bedankt voor het inschakelen van meldingen!",
      'message.action.resubscribed': "Meldingen zijn ingeschakeld",
      'message.action.unsubscribed': "Je ontvangt geen meldingen meer",
      'dialog.main.title': "Meldingen inschakelen",
      'dialog.main.button.subscribe': "Inschakelen",
      'dialog.main.button.unsubscribe': "Uitschakelen",
      'dialog.blocked.title': "Meldingen geblokkeerd",
      'dialog.blocked.message': "Schakel meldingen handmatig in via je browserinstellingen"
    }
  },
  promptOptions: {
    slidedown: {
      enabled: false,         // ‚úÖ geen automatische prompt
      autoPrompt: false,      // ‚úÖ niet automatisch vragen
      actionMessage: "Wil je meldingen ontvangen voor updates en hints?",
      acceptButtonText: "Ja, graag!",
      cancelButtonText: "Liever niet"
    }
  }   
     }).then(() => {
  if (view === "display" && ["37xskp", "z8kd01"].includes(team)) {
    OneSignal.User.addTags({ team: team });
     }
    });
  });
  </script>

  <!-- ‚úÖ Firebase (alleen database + storage) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
</head>
  <style>
  body {
    font-family: Arial, sans-serif;
    background-color: #000;
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    min-height: 100vh;
    margin: 0;
    padding: 1em;
    box-sizing: border-box;
    text-align: center;
  }

  #teamLabel {
    font-size: 1.5em;
    margin: 0.3em 0 1em;
    color: orange;
    display: none;
  }

  #timer {
    font-size: clamp(3em, 10vw, 6em);
    padding: 0.5em 1em;
    background: #111;
    border: 5px solid white;
    border-radius: 20px;
    text-align: center;
    margin-bottom: 1em;
    width: 80%;
    max-width: 500px;
  }

  .controls {
    margin-top: 1.5em;
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
  }

  button {
    padding: 0.8em;
    font-size: 1em;
    margin: 6px 0;
    background: red;
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    width: 100%;
    max-width: 280px;
  }

  input[type="text"], select {
    padding: 0.5em;
    font-size: 1em;
    width: 100%;
    max-width: 300px;
    margin: 8px 0;
    box-sizing: border-box;
  }

  #timeSlider {
    width: 100%;
    max-width: 500px;
    margin-top: 1em;
  }

  .flash {
    animation: flash 1s infinite;
  }

  @keyframes flash {
    0%, 100% { background: #111; color: white; }
    50% { background: red; color: black; }
  }

  .urgent {
    animation: urgentFlash 1s infinite;
  }

  @keyframes urgentFlash {
    0%, 100% { background: #111; color: white; }
    50% { background: darkred; color: yellow; transform: scale(1.05); }
  }

.footer {
  bottom: 1em;
  right: 1em;
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 0.3em;
  color: gray;
  font-size: 1.0em;
  text-align: right;
  z-index: 9999;
}

  #scoreBoard {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 1em;
    margin: 2em 0;
    width: 100%;
    max-width: 600px;
  }

  .scorecard {
    flex: 1 1 200px;
    max-width: 240px;
    background: #111;
    color: white;
    border: 5px solid white;
    border-radius: 20px;
    font-size: 2em;
    padding: 1em;
    cursor: pointer;
    text-align: center;
  }

  .scorecard .scoreName {
    font-size: 0.7em;
    color: orange;
    display: block;
    margin-bottom: 0.3em;
  }

  .scorecard.selected {
    border-color: orange;
  }

  #scoreControls {
    display: flex;
    justify-content: center;
    gap: 1em;
    flex-wrap: wrap;
    margin-top: 1em;
    width: 100%;
    max-width: 300px;
  }

  #scoreControls .score-btn {
    background: #222;
    color: white;
    border: 2px solid white;
    border-radius: 10px;
    padding: 0.5em;
    font-size: 1em;
    cursor: pointer;
    flex: 1 1 auto;
  }

#teamUploadIframeSection iframe {
  width: 100%;
  height: 530px; /* iets kleiner zodat de Jotform-footer net afvalt */
  min-height: 400px;
  overflow: hidden;
  border: none;
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(255,255,255,0.2);
  margin-bottom: 0;
  padding-bottom: 0;
}

@media (max-width: 767px) {
  #timer {
    font-size: clamp(2.2em, 8vw, 4em);
    padding: 0.3em 0.5em;
    margin-bottom: 0.5em;
  }
}

@media (max-width: 600px) {
  #teamUploadIframeSection iframe {
    height: 550px; /* iets ruimer als nodig */
    margin-bottom: 0;
  }
}

    .controls, .tekst-controls {
      max-width: 300px;
      width: 100%;
    }

    button, input[type="text"], select {
      font-size: 0.9em;
      padding: 0.5em;
      margin: 4px 0;
      max-width: 95%;
    }

    #timeSlider {
      margin-top: 0.5em;
      height: 20px;
    }

    .scorecard {
      flex: 1 1 45%;
      max-width: 25%;
    }
  }
</style>
</head>
<body>
<script>
window.addEventListener("DOMContentLoaded", () => {
  const urlParams = new URLSearchParams(window.location.search);
  const view = urlParams.get("view");
  const team = urlParams.get("team");

  const isDisplayMode = view === "display" && team && ["37xskp", "z8kd01"].includes(team);
  const isControlMode = view === "edit123";

  const pushMijlpalen = [7200, 5400, 3600, 1800, 600, 0];
  let laatstVerzondenMijlpaal = null;

   // HINT: Aanvragen door team (alleen displaymode)
  if (isDisplayMode) {
    const opdrachten = [
      "Opdracht 1", "Opdracht 2", "Opdracht 3", "Opdracht 4",
      "Opdracht 5", "Opdracht 6", "Opdracht 7", "Opdracht 8"
    ];
    const hintDiv = document.createElement("div");
    hintDiv.style = "margin: 2em 0; text-align: center";
    hintDiv.innerHTML = `
      <h3>üîç Hint aanvragen</h3>
      <select id="opdrachtSelect">
        <option value="">-- Kies een opdracht --</option>
        ${opdrachten.map((o, i) => `<option value="${i + 1}">${o}</option>`).join("")}
      </select><br/>
      <button id="vraagHintKnop" style="margin-top: 0.5em;">Vraag hint aan</button>
    `;
    document.body.appendChild(hintDiv);

    document.getElementById("vraagHintKnop")?.addEventListener("click", async () => {
      const opdracht = document.getElementById("opdrachtSelect")?.value;
      if (!opdracht) return alert("Kies een opdracht eerst.");

      try {
        await fetch("https://onesignal.com/api/v1/notifications", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Basic 5wpbbdzw5ugb4w2mghacxol4e"
          },
          body: JSON.stringify({
            app_id: "0c55e75a-a7cc-4829-8359-3171d4f456d0",
            headings: { nl: "Hint aangevraagd" },
            contents: { nl: `Team ${team} vraagt een hint aan bij opdracht ${opdracht}` },
            filters: [{ field: "tag", key: "view", relation: "=", value: "edit123" }]
          })
        });
        alert("Hintverzoek verstuurd!");
      } catch (err) {
        console.error("Fout bij hintverzoek:", err);
      }
    });
  }

  // AUTOMATISCHE PUSHMELDINGEN BIJ MIJLPAAL
  const db = firebase.database();
  const timerRef = db.ref("timer");

  timerRef.on("value", async (snapshot) => {
    const data = snapshot.val();
    if (!data || !data.running) return;

    const remaining = data.timestamp
      ? Math.max(0, Math.floor((9000 - (Date.now() - data.timestamp) / 1000)))
      : data.remaining;

    const mijlpaal = pushMijlpalen.find(m => Math.abs(remaining - m) <= 1);
    if (mijlpaal && mijlpaal !== laatstVerzondenMijlpaal) {
      laatstVerzondenMijlpaal = mijlpaal;

      const inhoud = mijlpaal === 0
        ? "‚è∞ De tijd is om!"
        : `üïí Nog ${Math.floor(mijlpaal / 60)} minuten te gaan!`;

      try {
        await fetch("https://onesignal.com/api/v1/notifications", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Basic 5wpbbdzw5ugb4w2mghacxol4e"
          },
          body: JSON.stringify({
            app_id: "0c55e75a-a7cc-4829-8359-3171d4f456d0",
            headings: { nl: "Tijdmelding" },
            contents: { nl: inhoud },
            filters: [{ field: "tag", key: "view", relation: "=", value: "display" }]
          })
        });
      } catch (e) {
        console.error("Fout bij automatische melding:", e);
         }
    }
  });

  // Blokkeer ongewenste toegang
  if (!isDisplayMode && !isControlMode) {
    document.body.innerHTML = `
      <div style="text-align:center; margin-top: 5em; font-family: sans-serif;">
        <h2>‚ùå Toegang geweigerd</h2>
      </div>
    `;
    return;
  }

  const teamCode = team;
  const allowedTeams = { "37xskp": "Team A", "z8kd01": "Team B" };

  const firebaseConfig = {
    apiKey: "AIzaSyA9PTsrTBR7cYf1oAfPtnyF4g9laqkdwng",
    authDomain: "puzzeltocht-maastricht.firebaseapp.com",
    databaseURL: "https://puzzeltocht-maastricht-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "puzzeltocht-maastricht",
    storageBucket: "puzzeltocht-maastricht.appspot.com",
    messagingSenderId: "825884044147",
    appId: "1:825884044147:web:f329c4af2373cbedbcb306"
  };

  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

  const timerRef = db.ref("timer");
  const tekstRef = db.ref("tekst");
  const teamnamenRef = db.ref("teamnamen");
  const scoresRef = db.ref("scores");

  if (isDisplayMode) {
    const isIos = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    const isStandalone = window.navigator.standalone === true;

    if (isIos && !isStandalone) {
      const installTip = document.createElement("div");
      installTip.innerHTML = `
        üì≤ <strong>Tip voor iPhone-gebruikers</strong><br/>
        Voeg deze pagina toe aan je beginscherm om meldingen te ontvangen.<br/><br/>
        Tik op <span style="font-size: 1.3em;">üîó</span> onderaan en kies <em>‚ÄòZet op beginscherm‚Äô</em>.
      `;
      installTip.style = `
        background: #220;
        color: orange;
        padding: 1em;
        margin: 1em auto;
        border: 1px solid orange;
        border-radius: 10px;
        text-align: center;
        max-width: 500px;
      `;
      document.body.prepend(installTip);
    }
  }

  const teamLabel = document.getElementById("teamLabel");
  if (isDisplayMode && teamCode && teamLabel) {
    teamnamenRef.child(teamCode).on("value", (snap) => {
      teamLabel.textContent = snap.val() || "Team onbekend";
      teamLabel.style.display = "block";
    });
  }

  if (isControlMode) {
    const inputA = document.getElementById("inputTeamA");
    const inputB = document.getElementById("inputTeamB");
    const knop = document.getElementById("opslaanTeamnamen");

    if (inputA && inputB && knop) {
      knop.addEventListener("click", () => {
        teamnamenRef.set({ "37xskp": inputA.value.trim(), "z8kd01": inputB.value.trim() });
      });
      teamnamenRef.once("value", (snap) => {
        const data = snap.val() || {};
        inputA.value = data["37xskp"] || "";
        inputB.value = data["z8kd01"] || "";
      });
    }
  }

  // === PUSHMELDINGSECTIE ALLEEN TONEN OP EDITPAGINA ===
const pushControls = document.getElementById("pushControls");
if (pushControls) {
  pushControls.style.display = isControlMode ? "block" : "none";
}

  teamnamenRef.on("value", (snap) => {
    const data = snap.val() || {};
    const scoreNameA = document.getElementById("scoreNameA");
    const scoreNameB = document.getElementById("scoreNameB");
    if (scoreNameA) scoreNameA.textContent = data["37xskp"] || "Team A";
    if (scoreNameB) scoreNameB.textContent = data["z8kd01"] || "Team B";
  });
  // === TIMER ===
  const timerDisplay = document.getElementById("timer");
  const slider = document.getElementById("timeSlider");
  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");
  const resetBtn = document.getElementById("resetBtn");
  const manualInput = document.getElementById("manualTimeInput");

  let totalSeconds = 9000;
  let remaining = totalSeconds;
  let interval = null;
  let previousRemaining = null; // om mijlpaal-overgangen te detecteren
   let flashTimeout = null;
  let isSliding = false;
 
  function formatTime(secs) {
    const h = String(Math.floor(secs / 3600)).padStart(2, '0');
    const m = String(Math.floor((secs % 3600) / 60)).padStart(2, '0');
    const s = String(secs % 60).padStart(2, '0');
    return `${h}:${m}:${s}`;
  }

  function updateDisplay() {
  if (timerDisplay && slider) {
    timerDisplay.textContent = remaining > 0 ? formatTime(remaining) : "TIJD OM!";
    slider.value = remaining;

    // Reset visuele effecten
    timerDisplay.classList.remove("flash", "urgent");
    timerDisplay.style.borderColor = "white";
    timerDisplay.style.backgroundColor = "#111";
    timerDisplay.style.color = "white";
    timerDisplay.style.transform = "scale(1)";

    // Mijlpaalkleuren
    if ([7200, 5400, 3600, 1800].includes(remaining)) {
      timerDisplay.classList.add("flash");
      setTimeout(() => timerDisplay.classList.remove("flash"), 10000);
    }

    // Laatste 10 minuten
    if (remaining > 0 && remaining <= 600) {
      const urgencyLevel = 10 - Math.floor(remaining / 60);
      const scale = 1 + urgencyLevel * 0.03;
      const color = `rgb(${100 + urgencyLevel * 15}, 0, 0)`;
      const bgColor = `rgb(${30 + urgencyLevel * 20}, 0, 0)`;
      timerDisplay.classList.add("urgent");
      timerDisplay.style.transform = `scale(${scale})`;
      timerDisplay.style.color = "yellow";
      timerDisplay.style.backgroundColor = bgColor;
      timerDisplay.style.borderColor = color;
    }
  }
}

function updateFirebase(running) {
  const data = {
    remaining,
    running
  };
  if (running) {
    data.timestamp = Date.now(); // ‚è± alleen bij starten toevoegen
  }
  timerRef.set(data);
}

function calcRemaining(rem, timestamp) {
  const passed = Math.floor((Date.now() - timestamp) / 1000);
  return Math.max(0, rem - passed);
}

timerRef.on("value", (snapshot) => {
  const data = snapshot.val();
  if (!data) return;

  const wasRunning = !!interval;
  const origineleRemaining = data.remaining ?? 9000;
  const startTimestamp = data.timestamp ?? Date.now();

  // Realtime berekening
  remaining = data.running
    ? calcRemaining(origineleRemaining, startTimestamp)
    : origineleRemaining;

  updateDisplay();

  if (data.running && remaining > 0) {
    if (interval) clearInterval(interval);
    interval = setInterval(() => {
      if (!isSliding) {
        remaining = calcRemaining(origineleRemaining, startTimestamp);

        // Mijlpaal-knipper bij 2u, 1.5u, 1u, 30min
        const mijlpalen = [7200, 5400, 3600, 1800];
        if (mijlpalen.includes(remaining) && remaining !== previousRemaining) {
          timerDisplay.classList.add("flash");
          if (flashTimeout) clearTimeout(flashTimeout);
          flashTimeout = setTimeout(() => {
            timerDisplay.classList.remove("flash");
            flashTimeout = null;
          }, 10000);
        }

        // URGENT effect bij laatste 10 min
        if (remaining > 0 && remaining <= 600) {
          const urgencyLevel = 10 - Math.floor(remaining / 60);
          const scale = 1 + urgencyLevel * 0.03;
          const color = `rgb(${100 + urgencyLevel * 15}, 0, 0)`;
          const bgColor = `rgb(${30 + urgencyLevel * 20}, 0, 0)`;
          timerDisplay.classList.add("urgent");
          timerDisplay.style.transform = `scale(${scale})`;
          timerDisplay.style.color = "yellow";
          timerDisplay.style.backgroundColor = bgColor;
          timerDisplay.style.borderColor = color;
        } else {
          timerDisplay.classList.remove("urgent");
          timerDisplay.style.transform = "scale(1)";
          timerDisplay.style.color = "white";
          timerDisplay.style.backgroundColor = "#111";
          timerDisplay.style.borderColor = "white";
        }

        previousRemaining = remaining;
        updateDisplay();
      }
    }, 1000);
  }

  if (!data.running && wasRunning) {
    clearInterval(interval);
    interval = null;
  }
});

// === BUTTONS ===
startBtn?.addEventListener("click", () => {
  if (remaining > 0) updateFirebase(true);
});

stopBtn?.addEventListener("click", () => {
  clearInterval(interval);
  interval = null;
  updateFirebase(false);
});

resetBtn?.addEventListener("click", () => {
  clearInterval(interval);
  interval = null;

  // Reset timer
  remaining = totalSeconds;
  updateDisplay();
  timerRef.set({
    remaining: totalSeconds,
    running: false
  });

  // Reset scores
  scoresRef.set({
    "37xskp": 0,
    "z8kd01": 0
  });

  // Reset teamnamen naar standaard
  teamnamenRef.set({
    "37xskp": allowedTeams["37xskp"],
    "z8kd01": allowedTeams["z8kd01"]
  });
});


  slider?.addEventListener("input", () => {
    isSliding = true;
    remaining = parseInt(slider.value);
    updateDisplay();
  });

  slider?.addEventListener("change", () => {
    isSliding = false;
    updateFirebase(!!interval);
  });

  window.stelHandmatigTijdIn = () => {
    if (!manualInput) return;
    const parts = manualInput.value.trim().split(":").map(Number);
    if (parts.length !== 3 || parts.some(isNaN)) {
      alert("Gebruik het formaat hh:mm:ss");
      return;
    }
    const [h, m, s] = parts;
    const nieuweTijd = h * 3600 + m * 60 + s;
    if (nieuweTijd > 9000) {
      alert("Maximale tijd is 2:30:00 (9000 sec)");
      return;
    }
    remaining = nieuweTijd;
    updateDisplay();
    updateFirebase(!!interval);
  };

  // === SCOREBORD ===
  const scoreCardA = document.getElementById("scoreCardA");
  const scoreCardB = document.getElementById("scoreCardB");
  const scoreValueA = document.getElementById("scoreValueA");
  const scoreValueB = document.getElementById("scoreValueB");
  const scoreControls = document.getElementById("scoreControls");

  let geselecteerdScoreCard = null;

  if (isControlMode && scoreControls) {
    scoreControls.style.display = "flex";

    function updateSelectedCard(card) {
      scoreCardA?.classList.remove("selected");
      scoreCardB?.classList.remove("selected");
      geselecteerdScoreCard = card;
      card.classList.add("selected");
    }

    scoreCardA?.addEventListener("click", () => updateSelectedCard(scoreCardA));
    scoreCardB?.addEventListener("click", () => updateSelectedCard(scoreCardB));

    document.getElementById("scorePlus1")?.addEventListener("click", () => wijzigScore(1));
    document.getElementById("scorePlus2")?.addEventListener("click", () => wijzigScore(2));
    document.getElementById("scoreMinus1")?.addEventListener("click", () => wijzigScore(-1));

    function wijzigScore(delta) {
      if (!geselecteerdScoreCard) return;
      const teamKey = geselecteerdScoreCard === scoreCardA ? "37xskp" : "z8kd01";
      scoresRef.child(teamKey).once("value", (snapshot) => {
        const huidigeScore = snapshot.val() || 0;
        scoresRef.child(teamKey).set(huidigeScore + delta);
      });
    }
  }

  scoresRef.on("value", (snapshot) => {
    const data = snapshot.val() || {};
    if (scoreValueA) scoreValueA.textContent = data["37xskp"] ?? 0;
    if (scoreValueB) scoreValueB.textContent = data["z8kd01"] ?? 0;
  });
  // === TEKSTEN ===
  const standaardTeksten = [
    "Welkom bij KDW 25! Veel plezier en succes vandaag!",
    "De volgende opdracht staat voor jullie klaar. Bekijk de aanwijzing goed.",
    "Let op: je kunt nu bonuspunten verdienen met een goede inschatting.",
    "Halverwege! Tijd voor een korte pauze of wisselmoment.",
    "De tijd tikt door ‚Äì vergeet niet in te leveren voor de deadline.",
    "Jullie hebben nog 30 minuten. Hou het tempo erin!",
    "Laatste 10 minuten ‚Äì nu telt alles!",
    "Verzamel je team en maak je klaar voor het eindspel.",
    "LET OP: Antwoorden worden niet meer geaccepteerd.",
    "Bedankt voor jullie deelname aan KDW 25!"
  ];

  tekstRef.on("value", (snapshot) => {
    const tekst = snapshot.val()?.inhoud || "";
    document.querySelectorAll(".tekst").forEach(el => {
      el.style.display = "none";
      el.textContent = "";
    });
    const index = standaardTeksten.indexOf(tekst);
    const id = index >= 0 ? `tekst${index + 1}` : "eigenTekst";
    const target = document.getElementById(id);
    if (target) {
      target.textContent = tekst;
      target.style.display = "block";
    }
  });

  window.toonVrijeTekst = () => {
    const input = document.getElementById("customTextInput");
    if (!input) return;
    const tekst = input.value.trim();
    tekstRef.set({ inhoud: tekst });
  };

  window.toonGeselecteerdeTekst = () => {
    const select = document.getElementById("tekstSelect");
    const index = parseInt(select.value);
    if (!isNaN(index) && index >= 1 && index <= 10) {
      tekstRef.set({ inhoud: standaardTeksten[index - 1] });
    }
  };

  window.verbergTeksten = () => {
    tekstRef.set({ inhoud: "" });
  };

  // === UI AANPASSINGEN ===
  const controlsDiv = document.querySelector(".controls");
  const tekstControls = document.getElementById("tekstControls");
  const logo = document.getElementById("logo");
  const title = document.getElementById("pageTitle");
  const teamUploadIframeSection = document.getElementById("teamUploadIframeSection");

  if (controlsDiv) controlsDiv.style.display = isDisplayMode ? "none" : "flex";
  if (tekstControls) tekstControls.style.display = isDisplayMode ? "none" : "block";
  if (slider) slider.style.display = isDisplayMode ? "none" : "block";
  if (logo) logo.style.display = isDisplayMode ? "block" : "none";
  if (title) title.style.display = isDisplayMode ? "block" : "none";

  // === JOTFORM IFRAME INVOEGEN PER TEAM ===
  const teamFormUrls = {
    "37xskp": "https://form.jotform.com/250903000714341",
    "z8kd01": "https://form.jotform.com/250901825652052"
  };

  if (isDisplayMode && teamCode && teamFormUrls[teamCode] && teamUploadIframeSection) {
    const iframe = document.createElement("iframe");
    iframe.id = "JotFormIFrame-" + teamCode;
    iframe.title = "Upload hier jullie foto's";
    iframe.allowTransparency = true;
    iframe.allow = "geolocation; microphone; camera; fullscreen";
    iframe.src = teamFormUrls[teamCode] + "?teamnaam=" + encodeURIComponent(allowedTeams[teamCode]);
    iframe.style = "min-width:100%;max-width:100%;height:800px;border:none;border-radius:10px;";
    iframe.scrolling = "no";

    teamUploadIframeSection.appendChild(iframe);
    teamUploadIframeSection.style.display = "block";

    const script = document.createElement("script");
    script.src = "https://cdn.jotfor.ms/s/umd/latest/for-form-embed-handler.js";
    document.body.appendChild(script);
  }

  // STAP 1b: Tags meegeven aan OneSignal
  if (isDisplayMode && teamCode && window.OneSignal) {
    OneSignal.sendTags({ team: teamCode });
  }

 window.stuurPushmelding = async () => {
  const teamSelect = document.getElementById("pushTeamSelect");
  const team = teamSelect?.value;
  const title = document.getElementById("pushTitle")?.value.trim();
  const body = document.getElementById("pushBody")?.value.trim();

  if (!title || !body) {
    alert("Vul een titel en bericht in.");
    return;
  }

  if (!team || !["37xskp", "z8kd01", "beide"].includes(team)) {
    alert("Kies een geldig team of 'Beide teams'.");
    return;
  }

  const apiKey = "5wpbbdzw5ugb4w2mghacxol4e";
  const appId = "0c55e75a-a7cc-4829-8359-3171d4f456d0";
  const teamsToNotify = team === "beide" ? ["37xskp", "z8kd01"] : [team];

  try {
    for (const t of teamsToNotify) {
      const response = await fetch("https://onesignal.com/api/v1/notifications", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Basic ${apiKey}`
        },
        body: JSON.stringify({
          app_id: appId,
          headings: { en: title },
          contents: { en: body },
          filters: [{ field: "tag", key: "team", relation: "=", value: t }]
        })
      });

      const result = await response.json();  // dit is nu in de juiste async functie
      if (!response.ok) {
        console.error("Fout bij verzenden naar team", t, result);
        alert(`‚ùå Fout bij verzenden naar team ${t}.`);
        return;
      }
    }

    alert("‚úÖ Melding verzonden!");
  } catch (err) {
    console.error("‚ùå Netwerkfout:", err);
    alert("Netwerkfout bij verzenden.");
  }

   if (isDisplayMode && teamCode && window.OneSignal) {
  OneSignal.getNotificationPermission().then(function (permission) {
    
    // üîî TOESTEMMING NOG NIET GEGEVEN
    if (permission === "default") {
      const uitlegDiv = document.createElement("div");
      uitlegDiv.innerHTML = `
        <div style="
          background: #222;
          color: orange;
          padding: 1em;
          margin: 1em auto;
          border: 1px solid orange;
          border-radius: 10px;
          text-align: center;
          max-width: 500px;
        ">
          üîî <strong>Belangrijk voor het spel</strong><br/>
          Om aanwijzingen en hints te ontvangen,<br/>
          is het belangrijk dat je meldingen toestaat in de volgende stap.<br/><br/>
          <button id="startOneSignalPrompt" style="
            padding: 0.7em 1.5em;
            background: orange;
            color: black;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
          ">OK, ga verder</button>
        </div>
      `;
      document.body.prepend(uitlegDiv);

      // üü† Handmatige knop
      document.getElementById("startOneSignalPrompt")?.addEventListener("click", () => {
        uitlegDiv.remove();
        OneSignal.showSlidedownPrompt();
      });

      // üïí Automatische prompt na 10 seconden
      setTimeout(() => {
        OneSignal.showSlidedownPrompt();
      }, 10000);
    }

    // ‚ùå MELDINGEN GEWEIGERD
    if (permission === "denied") {
      const isIos = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      const geweigerdDiv = document.createElement("div");

      geweigerdDiv.innerHTML = isIos
        ? `
        <div style="background: #220; color: orange; padding: 1em; margin: 1em auto;
                    border: 1px solid orange; border-radius: 10px; text-align: center;
                    max-width: 500px;">
          ‚ùå <strong>Meldingen geblokkeerd (iPhone/iPad)</strong><br/>
          Voor de spelbeleving zijn meldingen belangrijk.<br/>
          Je hebt ze geweigerd. Om ze alsnog toe te staan:<br/><br/>
          <ul style="text-align:left; padding-left:1em;">
            <li>üì± Open je iOS-instellingen</li>
            <li>üîç Zoek Safari of Chrome (afhankelijk van je browser)</li>
            <li>üîî Ga naar 'Meldingen'</li>
            <li>‚úÖ Zet meldingen aan voor deze site</li>
          </ul>
          <br/>
          Herlaad daarna deze pagina.
        </div>
        `
        : `
        <div style="background: #220; color: orange; padding: 1em; margin: 1em auto;
                    border: 1px solid orange; border-radius: 10px; text-align: center;
                    max-width: 500px;">
          ‚ùå <strong>Meldingen geblokkeerd</strong><br/>
          Voor de spelbeleving zijn meldingen belangrijk.<br/>
          Je hebt ze geweigerd. Om ze alsnog toe te staan:<br/><br/>
          <ul style="text-align:left; padding-left:1em;">
            <li>üîì Tik op het slotje of het info-icoontje naast het webadres</li>
            <li>üîî Zoek 'Meldingen' of 'Toestemmingen'</li>
            <li>‚úÖ Zet meldingen aan voor deze site</li>
          </ul>
          <br/>
          Herlaad daarna de pagina.
        </div>
        `;

      document.body.prepend(geweigerdDiv);
    }

  }); // einde .then
} // einde if isDisplayMode

}; // ‚úÖ sluit stuurPushmelding()
}); // ‚úÖ sluit DOMContentLoaded
</script>
</head>
<body>
  <h1 id="pageTitle" style="display: none; font-size: clamp(2.5em, 8vw, 5em); margin-bottom: 0.5em;">Code Maastricht</h1>

  <div id="teamLabel" style="display: none; font-size: 1.5em; color: orange; margin-bottom: 1em;"></div>

  <div id="timer">02:30:00</div>
  <input type="range" id="timeSlider" min="0" max="9000" value="9000" />

  <div class="controls">
    <input type="text" id="manualTimeInput" placeholder="hh:mm:ss" />
    <button onclick="stelHandmatigTijdIn()">Tijd instellen</button>
    <button id="startBtn">Start</button>
    <button id="stopBtn">Stop</button>
    <button id="resetBtn">Reset</button>
  </div>

  <div id="tekstControls" class="tekst-controls">
    <input type="text" id="customTextInput" placeholder="Eigen boodschap..." />
    <button onclick="toonVrijeTekst()">Toon eigen tekst</button>
    <select id="tekstSelect">
      <option value="">-- Kies een tekst --</option>
      <option value="1">1. Welkom bij KDW 25</option>
      <option value="2">2. Volgende opdracht beschikbaar</option>
      <option value="3">3. Kans op bonuspunten</option>
      <option value="4">4. Halverwege moment</option>
      <option value="5">5. Denk aan de deadline</option>
      <option value="6">6. Nog 30 minuten</option>
      <option value="7">7. Laatste 10 minuten</option>
      <option value="8">8. Eindspel voorbereiden</option>
      <option value="9">9. Geen antwoorden meer</option>
      <option value="10">10. Bedankt voor deelname</option>
    </select>
    <button onclick="toonGeselecteerdeTekst()">Toon geselecteerde tekst</button>
    <button onclick="verbergTeksten()">Verberg alles</button><br/>

    <input id="inputTeamA" type="text" placeholder="Naam voor Team A" style="margin-bottom: 0.5em;" /><br/>
    <input id="inputTeamB" type="text" placeholder="Naam voor Team B" style="margin-bottom: 0.5em;" /><br/>
    <button id="opslaanTeamnamen">Teamnamen opslaan</button>
  </div>

  <div id="tekstContainer">
    <div id="tekst1" class="tekst" style="display:none;"></div>
    <div id="tekst2" class="tekst" style="display:none;"></div>
    <div id="tekst3" class="tekst" style="display:none;"></div>
    <div id="tekst4" class="tekst" style="display:none;"></div>
    <div id="tekst5" class="tekst" style="display:none;"></div>
    <div id="tekst6" class="tekst" style="display:none;"></div>
    <div id="tekst7" class="tekst" style="display:none;"></div>
    <div id="tekst8" class="tekst" style="display:none;"></div>
    <div id="tekst9" class="tekst" style="display:none;"></div>
    <div id="tekst10" class="tekst" style="display:none;"></div>
    <div id="eigenTekst" class="tekst" style="display:none;"></div>
  </div>

  <div id="scoreBoard">
    <div id="scoreCardA" class="scorecard">
      <span id="scoreNameA" class="scoreName">Team A</span>
      <div id="scoreValueA">0</div>
    </div>
    <div id="scoreCardB" class="scorecard">
      <span id="scoreNameB" class="scoreName">Team B</span>
      <div id="scoreValueB">0</div>
    </div>
  </div>

  <div id="teamUploadIframeSection" style="width: 100%; max-width: 800px; margin: 2em auto; display: none;"></div>

  <div id="scoreControls" style="display: none;">
    <button id="scorePlus1">+1</button>
    <button id="scorePlus2">+2</button>
    <button id="scoreMinus1">-1</button>
  </div>

<div id="pushControls" style="display: none;">
  <hr style="margin: 1.5em 0; border: 1px solid #444;" />
  <h3 style="margin-bottom: 0.5em;">Pushmelding sturen</h3>

  <select id="pushTeamSelect">
    <option value="">-- Kies team --</option>
    <option value="37xskp">Team A</option>
    <option value="z8kd01">Team B</option>
    <option value="beide">Beide teams</option>
  </select><br/>

  <input type="text" id="pushTitle" placeholder="Titel" />
  <input type="text" id="pushBody" placeholder="Bericht" />
  <button onclick="stuurPushmelding()">Stuur pushmelding</button>
</div>
<!-- Logo -->
<img id="logo" src="KDW25.png" alt="KDW25 Logo" style="display: none; position: relative; margin: 2em auto 0 auto; height: clamp(150px, 30vw, 280px); opacity: 0.95; pointer-events: none;" />
   <!-- Footer -->
<div class="footer">
  <span>¬© Geerten Liesker</span>
</div>
</body>
</html>
