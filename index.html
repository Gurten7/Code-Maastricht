<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Puzzeltocht Maastricht</title>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <style>
  body {
    font-family: Arial, sans-serif;
    background-color: #000;
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    min-height: 100vh;
    margin: 0;
    padding: 2em;
    box-sizing: border-box;
  }

  #teamLabel {
    font-size: 2em; /* Grotere fontgrootte voor de teamnaam */
    margin: 1em 0;
    color: orange;
    display: none;
  }

  #timer {
    font-size: clamp(4em, 12vw, 8em); /* Grotere timer */
    padding: 1.2em 2em;
    background: #111;
    border: 5px solid white;
    border-radius: 20px;
    transition: background 0.3s, color 0.3s;
    text-align: center;
    margin-bottom: 2em;
    width: 80%;
    max-width: 600px;
  }

  .controls {
    margin-top: 2em;
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 80%;
    max-width: 500px;
  }

  button {
    padding: 1em;
    font-size: 1.2em;
    margin: 12px 0;
    background: red;
    color: white;
    border: none;
    border-radius: 15px;
    cursor: pointer;
    width: 100%;
    max-width: 350px;
  }

  input[type="text"], select {
    padding: 0.8em;
    font-size: 1.2em;
    margin: 8px 0;
    width: 100%;
    max-width: 350px;
    border-radius: 10px;
    border: 2px solid #444;
    background-color: #222;
    color: white;
  }

  input[type="text"]:focus, select:focus {
    outline: none;
    border-color: orange;
  }

  #timeSlider {
    width: 100%;
    max-width: 500px;
    margin-top: 1em;
  }

  .flash {
    animation: flash 1s infinite;
  }

  @keyframes flash {
    0%, 100% { background: #111; color: white; }
    50% { background: red; color: black; }
  }

  .urgent {
    animation: urgentFlash 1s infinite;
  }

  @keyframes urgentFlash {
    0%, 100% { background: #111; color: white; }
    50% { background: darkred; color: yellow; transform: scale(1.05); }
  }

  .footer {
    font-size: 1em;
    color: gray;
    position: fixed;
    bottom: 10px;
    right: 20px;
    z-index: 1;
  }

  #tekstContainer, #eigenTekst, .tekst-controls {
    width: 100%;
    max-width: 500px;
    text-align: center;
  }

  #tekstContainer .tekst, #eigenTekst {
    font-size: 1.2em;
    margin: 8px 0;
  }

  @media (max-width: 500px) {
    body {
      padding: 1em;
    }

    #timer {
      font-size: clamp(3em, 10vw, 6em);
      padding: 0.8em;
      margin-bottom: 1em;
    }

    .controls, .tekst-controls {
      width: 90%;
    }

    button, input[type="text"], select {
      font-size: 1em;
      padding: 0.6em;
      margin: 8px 0;
      max-width: 95%;
    }
  }

  @media (min-width: 768px) {
    body {
      justify-content: center;
      padding: 1.5em 2em;
    }

    #timer {
      font-size: clamp(4em, 8vw, 6em);
      margin-bottom: 1.5em;
    }

    .controls, .tekst-controls {
      max-width: 400px;
    }

    button, input[type="text"], select {
      font-size: 1.1em;
      padding: 1em;
      margin: 10px 0;
      max-width: 100%;
    }

    #timeSlider {
      max-width: 400px;
    }
  }
  </style>
  <script>
  window.addEventListener('DOMContentLoaded', () => {
    const firebaseConfig = {
      apiKey: "AIzaSyA9PTsrTBR7cYf1oAfPtnyF4g9laqkdwng",
      authDomain: "puzzeltocht-maastricht.firebaseapp.com",
      databaseURL: "https://puzzeltocht-maastricht-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "puzzeltocht-maastricht",
      storageBucket: "puzzeltocht-maastricht.appspot.com",
      messagingSenderId: "825884044147",
      appId: "1:825884044147:web:f329c4af2373cbedbcb306"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const timerRef = db.ref("timer");
    const tekstRef = db.ref("tekst");
    const teamnamenRef = db.ref("teamnamen");

    const urlParams = new URLSearchParams(window.location.search);
    const isDisplayMode = urlParams.get('view') === 'display';
    const isControlMode = urlParams.get('view') === 'edit123';
    const teamCode = urlParams.get('team');

    const allowedTeams = {
      "37xskp": "Team A",
      "z8kd01": "Team B"
    };

    const teamLabel = document.getElementById("teamLabel");

    if (isDisplayMode && !(teamCode in allowedTeams)) {
      document.body.innerHTML = '<h2 style="color: red; text-align: center; margin-top: 2em;">Toegang geweigerd</h2>';
      return;
    }

    if (!isDisplayMode && !isControlMode) {
      document.body.innerHTML = '<h2 style="color: red; text-align: center; margin-top: 2em;">Toegang geweigerd</h2>';
      return;
    }

    if (isDisplayMode && teamCode) {
      teamnamenRef.child(teamCode).on("value", (snapshot) => {
        const naam = snapshot.val();
        if (teamLabel) {
          teamLabel.textContent = naam || "Team onbekend";
          teamLabel.style.display = "block";
        }
      });
    }

    if (isControlMode) {
      const inputA = document.getElementById("inputTeamA");
      const inputB = document.getElementById("inputTeamB");
      const knopOpslaan = document.getElementById("opslaanTeamnamen");
      if (knopOpslaan && inputA && inputB) {
        knopOpslaan.addEventListener("click", () => {
          const naamA = inputA.value.trim();
          const naamB = inputB.value.trim();
          teamnamenRef.set({
            "37xskp": naamA,
            "z8kd01": naamB
          });
        });
        teamnamenRef.once("value", (snapshot) => {
          const data = snapshot.val() || {};
          inputA.value = data["37xskp"] || "";
          inputB.value = data["z8kd01"] || "";
        });
      }
    }

    const timerDisplay = document.getElementById("timer");
    const slider = document.getElementById("timeSlider");
    const logo = document.getElementById("logo");
    if (logo) logo.style.display = isDisplayMode ? 'block' : 'none';
    const title = document.getElementById('pageTitle');
    if (title) title.style.display = isDisplayMode ? 'block' : 'none';

    let totalSeconds = 9000;
    let remaining = totalSeconds;
    let interval = null;
    let isSliding = false;

    function formatTime(secs) {
      const h = String(Math.floor(secs / 3600)).padStart(2, '0');
      const m = String(Math.floor((secs % 3600) / 60)).padStart(2, '0');
      const s = String(secs % 60).padStart(2, '0');
      return `${h}:${m}:${s}`;
    }

    function updateDisplay() {
      if (!timerDisplay) return;
      timerDisplay.textContent = formatTime(remaining);
      if (slider) slider.value = remaining;

      if ([7200, 5400, 3600, 1800].includes(remaining)) {
        timerDisplay.classList.add("flash");
        setTimeout(() => timerDisplay.classList.remove("flash"), 10000);
      }

      if (remaining <= 600 && remaining > 0) {
        const urgencyLevel = 10 - remaining / 60;
        const scale = 1 + urgencyLevel * 0.03;
        const color = `rgb(${100 + urgencyLevel * 15}, 0, 0)`;
        const bgColor = `rgb(${30 + urgencyLevel * 20}, 0, 0)`;

        timerDisplay.classList.add("urgent");
        timerDisplay.style.transform = `scale(${scale})`;
        timerDisplay.style.color = "yellow";
        timerDisplay.style.backgroundColor = bgColor;
        timerDisplay.style.borderColor = color;
      }

      if (remaining <= 0) {
        clearInterval(interval);
        interval = null;
        timerDisplay.classList.remove("urgent");
        timerDisplay.textContent = "TIJD OM!";
        const finalMessage = document.getElementById("finalMessage");
        if (finalMessage) {
          finalMessage.textContent = "";
          finalMessage.style.display = "none";
        }
      }
    }

    function updateFirebase(isRunning) {
      timerRef.set({
        remaining,
        running: isRunning,
        timestamp: Date.now(),
        geheim: "edit123"
      });
    }

    function berekenRemaining(remaining, timestamp) {
      const secondsPassed = Math.floor((Date.now() - timestamp) / 1000);
      return Math.max(0, remaining - secondsPassed);
    }

    timerRef.on("value", (snapshot) => {
      const data = snapshot.val();
      if (!data) return;

      const wasRunning = !!interval;
      remaining = data.running
        ? berekenRemaining(data.remaining, data.timestamp)
        : data.remaining;
      updateDisplay();

      if (data.running && !interval && remaining > 0) {
        interval = setInterval(() => {
          remaining--;
          updateDisplay();
          updateFirebase(true);
        }, 1000);
      }

      if (!data.running && wasRunning) {
        clearInterval(interval);
        interval = null;
      }
    });

    tekstRef.on("value", (snapshot) => {
      const data = snapshot.val();
      const tekst = data?.inhoud || "";

      document.querySelectorAll('.tekst').forEach(el => {
        el.textContent = "";
        el.style.display = "none";
      });

      if (!tekst) return;

      const standaardTeksten = [
        "Welkom bij KDW 25! Veel plezier en succes vandaag!",
        "De volgende opdracht staat voor jullie klaar. Bekijk de aanwijzing goed.",
        "Let op: je kunt nu bonuspunten verdienen met een goede inschatting.",
        "Halverwege! Tijd voor een korte pauze of wisselmoment.",
        "De tijd tikt door – vergeet niet in te leveren voor de deadline.",
        "Jullie hebben nog 30 minuten. Hou het tempo erin!",
        "Laatste 10 minuten – nu telt alles!",
        "Verzamel je team en maak je klaar voor het eindspel.",
        "LET OP: Antwoorden worden niet meer geaccepteerd.",
        "Bedankt voor jullie deelname aan KDW 25!"
      ];

      const index = standaardTeksten.indexOf(tekst);
      const tekstId = index >= 0 ? `tekst${index + 1}` : "eigenTekst";

      const targetDiv = document.getElementById(tekstId);
      if (targetDiv) {
        targetDiv.textContent = tekst;
        targetDiv.style.display = "block";
      }
    });

    document.getElementById("startBtn").addEventListener("click", () => {
      if (interval) return;
      interval = setInterval(() => {
        if (!isSliding && remaining > 0) {
          remaining--;
          updateDisplay();
          updateFirebase(true);
        }
      }, 1000);
      updateFirebase(true);
    });

    document.getElementById("stopBtn").addEventListener("click", () => {
      clearInterval(interval);
      interval = null;
      updateFirebase(false);
    });

    document.getElementById("resetBtn").addEventListener("click", () => {
      clearInterval(interval);
      interval = null;
      remaining = totalSeconds;
      timerDisplay.classList.remove("flash", "urgent");
      timerDisplay.style.borderColor = "white";
      timerDisplay.style.backgroundColor = "#111";
      timerDisplay.style.color = "white";
      timerDisplay.style.transform = "scale(1)";
      updateDisplay();
      updateFirebase(false);
    });

    if (slider) {
      slider.addEventListener("input", () => {
        isSliding = true;
        remaining = parseInt(slider.value);
        updateDisplay();
      });

      slider.addEventListener("change", () => {
        isSliding = false;
        updateFirebase(!!interval);
      });
    }

    if (isDisplayMode) {
      const controls = document.querySelector('.controls');
      if (controls) controls.style.display = 'none';
      const tekstControls = document.getElementById('tekstControls');
      if (tekstControls) tekstControls.style.display = 'none';
      if (slider) slider.style.display = 'none';
    }

    window.stelHandmatigTijdIn = () => {
      const input = document.getElementById("manualTimeInput").value.trim();
      const parts = input.split(":");
      if (parts.length !== 3) {
        alert("Voer een tijd in als hh:mm:ss");
        return;
      }
      const [h, m, s] = parts.map(Number);
      if ([h, m, s].some(isNaN) || h < 0 || m < 0 || s < 0 || m > 59 || s > 59) {
        alert("Ongeldige tijd. Zorg voor hh:mm:ss met geldige getallen.");
        return;
      }
      totalSeconds = h * 3600 + m * 60 + s;
      remaining = totalSeconds;
      updateDisplay();
      updateFirebase(false);
    };

    window.toonVrijeTekst = () => {
      const tekst = document.getElementById("customTextInput").value.trim();
      if (tekst) {
        tekstRef.set({ inhoud: tekst, geheim: "edit123" });
      }
    };

    window.toonGeselecteerdeTekst = () => {
      const nr = parseInt(document.getElementById('tekstSelect').value);
      if (!isNaN(nr)) {
        toonTekst(nr);
      }
    };

    window.verbergTeksten = (verbergEigen = true) => {
      const tekstSelect = document.getElementById('tekstSelect');
      const customTextInput = document.getElementById('customTextInput');
      const vrijeEl = document.getElementById('eigenTekst');

      document.querySelectorAll('.tekst').forEach(el => {
        if (!verbergEigen && el.id === 'eigenTekst') return;
        el.textContent = '';
        el.style.display = 'none';
      });

      if (tekstSelect) tekstSelect.value = "";
      if (customTextInput) customTextInput.value = "";
      if (vrijeEl) vrijeEl.textContent = "";

      tekstRef.set({ inhoud: "", geheim: "edit123" });
    };

    function toonTekst(nr) {
      const teksten = [
        "Welkom bij KDW 25! Veel plezier en succes vandaag!",
        "De volgende opdracht staat voor jullie klaar. Bekijk de aanwijzing goed.",
        "Let op: je kunt nu bonuspunten verdienen met een goede inschatting.",
        "Halverwege! Tijd voor een korte pauze of wisselmoment.",
        "De tijd tikt door – vergeet niet in te leveren voor de deadline.",
        "Jullie hebben nog 30 minuten. Hou het tempo erin!",
        "Laatste 10 minuten – nu telt alles!",
        "Verzamel je team en maak je klaar voor het eindspel.",
        "LET OP: Antwoorden worden niet meer geaccepteerd.",
        "Bedankt voor jullie deelname aan KDW 25!"
      ];
      if (!isNaN(nr) && teksten[nr - 1]) {
        tekstRef.set({ inhoud: teksten[nr - 1], geheim: "edit123" });
      }
    }
  });
  </script>
</body>
</html>
