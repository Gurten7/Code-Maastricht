<!DOCTYPE html>

<html lang="nl">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<title>Puzzeltocht Maastricht</title>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<style>
    body {
      font-family: Arial, sans-serif;
      background-color: #000;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      margin: 0;
      padding: 1em;
      box-sizing: border-box;
    }
    #teamLabel {
      font-size: 3.0em;
      margin: 0.3em 0 1em;
      color: orange;
      display: none;
    }
    #timer {
      font-size: clamp(6em, 16vw, 12em);
      padding: 0.5em 1em;
      background: #111;
      border: 5px solid white;
      border-radius: 20px;
      transition: background 0.3s, color 0.3s;
      text-align: center;
      margin-bottom: 1em;
    }
    .controls {
      margin-top: 1.5em;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }
    button {
      padding: 0.8em;
      font-size: 1em;
      margin: 6px 0;
      background: red;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      width: 100%;
      max-width: 280px;
    }
    input[type="text"] {
      padding: 0.5em;
      font-size: 1em;
      width: 100%;
      max-width: 300px;
      margin: 8px 0;
      box-sizing: border-box;
    }
    select {
      font-size: 1em;
      padding: 0.6em;
      width: 100%;
      max-width: 300px;
      margin: 8px 0;
    }
    #timeSlider {
      width: 100%;
      max-width: 500px;
      margin-top: 1em;
    }
    .flash {
      animation: flash 1s infinite;
    }
    @keyframes flash {
      0%, 100% { background: #111; color: white; }
      50% { background: red; color: black; }
    }
    .urgent {
      animation: urgentFlash 1s infinite;
    }
    @keyframes urgentFlash {
      0%, 100% { background: #111; color: white; }
      50% { background: darkred; color: yellow; transform: scale(1.05); }
    }
    .footer {
      font-size: 1em;
      color: gray;
      position: fixed;
      bottom: 10px;
      right: 20px;
    }
    @media (max-width: 767px) {
      #teamLabel {
        font-size: 1.7em;
      }
      #timer {
        font-size: clamp(5.0em, 16vw, 8em);
      }
      .controls, .tekst-controls {
        max-width: 300px;
        width: 100%;
      }
      button, input[type="text"], select {
        font-size: 0.9em;
        padding: 0.5em;
        margin: 4px 0;
        max-width: 95%;
      }
      #timeSlider {
        margin-top: 0.5em;
        height: 20px;
      }
      #timer {
        font-size: clamp(2.2em, 8vw, 4em);
        padding: 0.3em 0.5em;
        margin-bottom: 0.5em;
      }
      body {
        padding: 0.5em;
      }
    }
    @media (min-width: 768px) {
      body {
        justify-content: center;
        padding: 0.5em 1em;
      }
      #timer {
        font-size: clamp(3em, 6vw, 5em);
        margin-bottom: 0.5em;
      }
      .controls, .tekst-controls {
        max-width: 400px;
      }
      button, input[type="text"], select {
        font-size: 1em;
        padding: 0.5em;
        margin: 4px 0;
        max-width: 100%;
      }
      #timeSlider {
        margin: 0.5em 0 1em 0;
        max-width: 400px;
      }
    }
  </style>
<script>
  window.addEventListener('DOMContentLoaded', () => {
    const firebaseConfig = {
      apiKey: "AIzaSyA9PTsrTBR7cYf1oAfPtnyF4g9laqkdwng",
      authDomain: "puzzeltocht-maastricht.firebaseapp.com",
      databaseURL: "https://puzzeltocht-maastricht-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "puzzeltocht-maastricht",
      storageBucket: "puzzeltocht-maastricht.appspot.com",
      messagingSenderId: "825884044147",
      appId: "1:825884044147:web:f329c4af2373cbedbcb306"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const timerRef = db.ref("timer");
    const tekstRef = db.ref("tekst");
    const teamnamenRef = db.ref("teamnamen");

    const urlParams = new URLSearchParams(window.location.search);
    const isDisplayMode = urlParams.get('view') === 'display';
    const isControlMode = urlParams.get('view') === 'edit123';
    const teamCode = urlParams.get('team');

    const allowedTeams = {
      "37xskp": "Team A",
      "z8kd01": "Team B"
    };

    const teamLabel = document.getElementById("teamLabel");

    if (isDisplayMode && !(teamCode in allowedTeams)) {
      document.body.innerHTML = '<h2 style="color: red; text-align: center; margin-top: 2em;">Toegang geweigerd</h2>';
      return;
    }

    if (!isDisplayMode && !isControlMode) {
      document.body.innerHTML = '<h2 style="color: red; text-align: center; margin-top: 2em;">Toegang geweigerd</h2>';
      return;
    }

    if (isDisplayMode && teamCode) {
      teamnamenRef.child(teamCode).on("value", (snapshot) => {
        const naam = snapshot.val();
        if (teamLabel) {
          teamLabel.textContent = naam || "Team onbekend";
          teamLabel.style.display = "block";
        }
      });
    }

    if (isControlMode) {
      const inputA = document.getElementById("inputTeamA");
      const inputB = document.getElementById("inputTeamB");
      const knopOpslaan = document.getElementById("opslaanTeamnamen");
      if (knopOpslaan && inputA && inputB) {
        knopOpslaan.addEventListener("click", () => {
          const naamA = inputA.value.trim();
          const naamB = inputB.value.trim();
          teamnamenRef.set({
            "37xskp": naamA,
            "z8kd01": naamB
          });
        });
        teamnamenRef.once("value", (snapshot) => {
          const data = snapshot.val() || {};
          inputA.value = data["37xskp"] || "";
          inputB.value = data["z8kd01"] || "";
        });
      }
    }

    const timerDisplay = document.getElementById("timer");
    const slider = document.getElementById("timeSlider");
    const logo = document.getElementById("logo");
    if (logo) logo.style.display = isDisplayMode ? 'block' : 'none';
    const title = document.getElementById('pageTitle');
    if (title) title.style.display = isDisplayMode ? 'block' : 'none';

    let totalSeconds = 9000;
    let remaining = totalSeconds;
    let interval = null;
    let isSliding = false;

    function formatTime(secs) {
      const h = String(Math.floor(secs / 3600)).padStart(2, '0');
      const m = String(Math.floor((secs % 3600) / 60)).padStart(2, '0');
      const s = String(secs % 60).padStart(2, '0');
      return `${h}:${m}:${s}`;
    }

    function updateDisplay() {
      if (!timerDisplay) return;
      timerDisplay.textContent = formatTime(remaining);
      if (slider) slider.value = remaining;

      if ([7200, 5400, 3600, 1800].includes(remaining)) {
        timerDisplay.classList.add("flash");
        setTimeout(() => timerDisplay.classList.remove("flash"), 10000);
      }

      if (remaining <= 600 && remaining > 0) {
        const urgencyLevel = 10 - remaining / 60;
        const scale = 1 + urgencyLevel * 0.03;
        const color = `rgb(${100 + urgencyLevel * 15}, 0, 0)`;
        const bgColor = `rgb(${30 + urgencyLevel * 20}, 0, 0)`;

        timerDisplay.classList.add("urgent");
        timerDisplay.style.transform = `scale(${scale})`;
        timerDisplay.style.color = "yellow";
        timerDisplay.style.backgroundColor = bgColor;
        timerDisplay.style.borderColor = color;
      }

      if (remaining <= 0) {
        clearInterval(interval);
        interval = null;
        timerDisplay.classList.remove("urgent");
        timerDisplay.textContent = "TIJD OM!";
        const finalMessage = document.getElementById("finalMessage");
        if (finalMessage) {
          finalMessage.textContent = "";
          finalMessage.style.display = "none";
        }
      }
    }

    function updateFirebase(isRunning) {
      timerRef.set({
        remaining,
        running: isRunning,
        timestamp: Date.now(),
        geheim: "edit123"
      });
    }

    function berekenRemaining(remaining, timestamp) {
      const secondsPassed = Math.floor((Date.now() - timestamp) / 1000);
      return Math.max(0, remaining - secondsPassed);
    }

    timerRef.on("value", (snapshot) => {
      const data = snapshot.val();
      if (!data) return;

      const wasRunning = !!interval;
      remaining = data.running
        ? berekenRemaining(data.remaining, data.timestamp)
        : data.remaining;
      updateDisplay();

      if (data.running && !interval && remaining > 0) {
        interval = setInterval(() => {
          remaining--;
          updateDisplay();
          updateFirebase(true);
        }, 1000);
      }

      if (!data.running && wasRunning) {
        clearInterval(interval);
        interval = null;
      }
    });

    tekstRef.on("value", (snapshot) => {
      const data = snapshot.val();
      const tekst = data?.inhoud || "";

      document.querySelectorAll('.tekst').forEach(el => {
        el.textContent = "";
        el.style.display = "none";
      });

      if (!tekst) return;

      const standaardTeksten = [
        "Welkom bij KDW 25! Veel plezier en succes vandaag!",
        "De volgende opdracht staat voor jullie klaar. Bekijk de aanwijzing goed.",
        "Let op: je kunt nu bonuspunten verdienen met een goede inschatting.",
        "Halverwege! Tijd voor een korte pauze of wisselmoment.",
        "De tijd tikt door – vergeet niet in te leveren voor de deadline.",
        "Jullie hebben nog 30 minuten. Hou het tempo erin!",
        "Laatste 10 minuten – nu telt alles!",
        "Verzamel je team en maak je klaar voor het eindspel.",
        "LET OP: Antwoorden worden niet meer geaccepteerd.",
        "Bedankt voor jullie deelname aan KDW 25!"
      ];

      const index = standaardTeksten.indexOf(tekst);
      const tekstId = index >= 0 ? `tekst${index + 1}` : "eigenTekst";

      const targetDiv = document.getElementById(tekstId);
      if (targetDiv) {
        targetDiv.textContent = tekst;
        targetDiv.style.display = "block";
      }
    });

    document.getElementById("startBtn").addEventListener("click", () => {
      if (interval) return;
      interval = setInterval(() => {
        if (!isSliding && remaining > 0) {
          remaining--;
          updateDisplay();
          updateFirebase(true);
        }
      }, 1000);
      updateFirebase(true);
    });

    document.getElementById("stopBtn").addEventListener("click", () => {
      clearInterval(interval);
      interval = null;
      updateFirebase(false);
    });

    document.getElementById("resetBtn").addEventListener("click", () => {
      clearInterval(interval);
      interval = null;
      remaining = totalSeconds;
      timerDisplay.classList.remove("flash", "urgent");
      timerDisplay.style.borderColor = "white";
      timerDisplay.style.backgroundColor = "#111";
      timerDisplay.style.color = "white";
      timerDisplay.style.transform = "scale(1)";
      updateDisplay();
      updateFirebase(false);
    });

    if (slider) {
      slider.addEventListener("input", () => {
        isSliding = true;
        remaining = parseInt(slider.value);
        updateDisplay();
      });

      slider.addEventListener("change", () => {
        isSliding = false;
        updateFirebase(!!interval);
      });
    }

    if (isDisplayMode) {
      const controls = document.querySelector('.controls');
      if (controls) controls.style.display = 'none';
      const tekstControls = document.getElementById('tekstControls');
      if (tekstControls) tekstControls.style.display = 'none';
      if (slider) slider.style.display = 'none';
    }

    window.stelHandmatigTijdIn = () => {
      const input = document.getElementById("manualTimeInput").value.trim();
      const parts = input.split(":");
      if (parts.length !== 3) {
        alert("Voer een tijd in als hh:mm:ss");
        return;
      }
      const [h, m, s] = parts.map(Number);
      if ([h, m, s].some(isNaN) || h < 0 || m < 0 || s < 0 || m > 59 || s > 59) {
        alert("Ongeldige tijd. Zorg voor hh:mm:ss met geldige getallen.");
        return;
      }
      totalSeconds = h * 3600 + m * 60 + s;
      remaining = totalSeconds;
      updateDisplay();
      updateFirebase(false);
    };

    window.toonVrijeTekst = () => {
      const tekst = document.getElementById("customTextInput").value.trim();
      if (tekst) {
        tekstRef.set({ inhoud: tekst, geheim: "edit123" });
      }
    };

    window.toonGeselecteerdeTekst = () => {
      const nr = parseInt(document.getElementById('tekstSelect').value);
      if (!isNaN(nr)) {
        toonTekst(nr);
      }
    };

    window.verbergTeksten = (verbergEigen = true) => {
      const tekstSelect = document.getElementById('tekstSelect');
      const customTextInput = document.getElementById('customTextInput');
      const vrijeEl = document.getElementById('eigenTekst');

      document.querySelectorAll('.tekst').forEach(el => {
        if (!verbergEigen && el.id === 'eigenTekst') return;
        el.textContent = '';
        el.style.display = 'none';
      });

      if (tekstSelect) tekstSelect.value = "";
      if (customTextInput) customTextInput.value = "";
      if (vrijeEl) vrijeEl.textContent = "";

      tekstRef.set({ inhoud: "", geheim: "edit123" });
    };

    function toonTekst(nr) {
      const teksten = [
        "Welkom bij KDW 25! Veel plezier en succes vandaag!",
        "De volgende opdracht staat voor jullie klaar. Bekijk de aanwijzing goed.",
        "Let op: je kunt nu bonuspunten verdienen met een goede inschatting.",
        "Halverwege! Tijd voor een korte pauze of wisselmoment.",
        "De tijd tikt door – vergeet niet in te leveren voor de deadline.",
        "Jullie hebben nog 30 minuten. Hou het tempo erin!",
        "Laatste 10 minuten – nu telt alles!",
        "Verzamel je team en maak je klaar voor het eindspel.",
        "LET OP: Antwoorden worden niet meer geaccepteerd.",
        "Bedankt voor jullie deelname aan KDW 25!"
      ];
      if (!isNaN(nr) && teksten[nr - 1]) {
        tekstRef.set({ inhoud: teksten[nr - 1], geheim: "edit123" });
      }
    }
  });
  </script>
</head>
<body>
<script>
    let selectedTeam = null;

    // Function to highlight the selected team for score assignment
    function selectTeam(team) {
        // Reset all teams
        document.querySelectorAll('.scoreboard').forEach(el => {
            el.style.borderColor = "#fff";
        });

        // Highlight selected team
        const teamElement = document.getElementById(team);
        teamElement.style.borderColor = "orange";
        selectedTeam = team;
    }

    // Function to update score
    function updateScore(increment) {
        if (!selectedTeam) return; // If no team is selected

        const scoreElement = document.getElementById(selectedTeam + 'Score');
        let currentScore = parseInt(scoreElement.textContent);
        currentScore += increment;
        scoreElement.textContent = currentScore;

        // Synchronize the updated score with Firebase
        const scoreRef = firebase.database().ref('teamScores/' + selectedTeam);
        scoreRef.set(currentScore);
    }
</script>
<h1 id="pageTitle" style="display: none; font-size: clamp(2.5em, 8vw, 5em); margin-bottom: 0.5em;">Code Maastricht</h1>
<div id="teamLabel"></div>
<div id="timer">02:30:00</div>
<div id="finalMessage" style="display:none;"></div>
<input id="timeSlider" max="9000" min="0" type="range" value="9000"/>
<div class="controls">
<input id="manualTimeInput" placeholder="hh:mm:ss" type="text"/>
<button onclick="stelHandmatigTijdIn()">Tijd instellen</button>
<button id="startBtn">Start</button>
<button id="stopBtn">Stop</button>
<button id="resetBtn">Reset</button>
</div>
<div id="tekstContainer">
<div class="tekst" id="tekst1" style="display:none;"></div>
<div class="tekst" id="tekst2" style="display:none;"></div>
<div class="tekst" id="tekst3" style="display:none;"></div>
<div class="tekst" id="tekst4" style="display:none;"></div>
<div class="tekst" id="tekst5" style="display:none;"></div>
<div class="tekst" id="tekst6" style="display:none;"></div>
<div class="tekst" id="tekst7" style="display:none;"></div>
<div class="tekst" id="tekst8" style="display:none;"></div>
<div class="tekst" id="tekst9" style="display:none;"></div>
<div class="tekst" id="tekst10" style="display:none;"></div>
</div>
<div class="tekst" id="eigenTekst" style="display:none;"></div>
<div class="tekst-controls" id="tekstControls">
<input id="customTextInput" placeholder="Eigen boodschap..." type="text"/>
<button onclick="toonVrijeTekst()">Toon eigen tekst</button>
<select id="tekstSelect">
<option value="">-- Kies een tekst --</option>
<option value="1">1. Welkom bij KDW 25</option>
<option value="2">2. Volgende opdracht beschikbaar</option>
<option value="3">3. Kans op bonuspunten</option>
<option value="4">4. Halverwege moment</option>
<option value="5">5. Denk aan de deadline</option>
<option value="6">6. Nog 30 minuten</option>
<option value="7">7. Laatste 10 minuten</option>
<option value="8">8. Eindspel voorbereiden</option>
<option value="9">9. Geen antwoorden meer</option>
<option value="10">10. Bedankt voor deelname</option>
</select>
<button onclick="toonGeselecteerdeTekst()">Toon geselecteerde tekst</button>
<button onclick="verbergTeksten()">Verberg alles</button>
<input id="inputTeamA" placeholder="Naam voor Team A" style="margin-bottom: 0.5em; padding: 0.5em; width: 250px;" type="text"><br/>
<input id="inputTeamB" placeholder="Naam voor Team B" style="margin-bottom: 0.5em; padding: 0.5em; width: 250px;" type="text"><br/>
<button id="opslaanTeamnamen">Teamnamen opslaan</button>
</input></input></div>
<div class="footer">© Geerten Liesker</div>
<div id="scoreBoard" style="display: flex; justify-content: center; gap: 1em; margin: 2em 0;"><div id="scoreA" style="flex: 1; max-width: 240px; background: #111; color: white; border: 5px solid white; border-radius: 20px; font-size: 2em; padding: 1em;">0</div><div id="scoreB" style="flex: 1; max-width: 240px; background: #111; color: white; border: 5px solid white; border-radius: 20px; font-size: 2em; padding: 1em;">0</div></div><img alt="KDW 25 Logo" id="logo" src="KDW25.png" style="display: none; position: relative; margin: 2em auto 0 auto; height: clamp(150px, 30vw, 280px); opacity: 0.95; pointer-events: none; display: block;"/>
<script>
const isEdit = new URLSearchParams(window.location.search).get('view') === 'edit123';
const scoresRef = firebase.database().ref("scores");

function updateScoresDisplay(data) {
  if (document.getElementById("scoreA")) document.getElementById("scoreA").textContent = data.A ?? 0;
  if (document.getElementById("scoreB")) document.getElementById("scoreB").textContent = data.B ?? 0;
}
scoresRef.on("value", (snapshot) => updateScoresDisplay(snapshot.val() || {}));

if (isEdit) {
  const controlDiv = document.createElement("div");
  controlDiv.style = "display:flex;flex-direction:column;gap:0.5em;margin:2em auto;width:100%;max-width:300px";

  const btns = [
    { team: "A", delta: 1 },
    { team: "A", delta: 2 },
    { team: "A", delta: -1 },
    { team: "B", delta: 1 },
    { team: "B", delta: 2 },
    { team: "B", delta: -1 },
  ];

  btns.forEach(({ team, delta }) => {
    const btn = document.createElement("button");
    btn.textContent = `Team ${team} ${delta > 0 ? "+" + delta : delta}`;
    btn.onclick = () => {
      scoresRef.once("value").then((snap) => {
        const val = snap.val() || {};
        val[team] = (val[team] || 0) + delta;
        scoresRef.set(val);
      });
    };
    btn.style = "padding:0.5em;font-size:1.1em;background:#222;color:white;border-radius:10px;border:2px solid white;";
    controlDiv.appendChild(btn);
  });

  document.body.appendChild(controlDiv);
}
</script></body>
</html>
