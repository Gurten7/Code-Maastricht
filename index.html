<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Puzzeltocht Maastricht</title>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const firebaseConfig = {
        apiKey: "AIzaSyA9PTsrTBR7cYf1oAfPtnyF4g9laqkdwng",
        authDomain: "puzzeltocht-maastricht.firebaseapp.com",
        databaseURL: "https://puzzeltocht-maastricht-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "puzzeltocht-maastricht",
        storageBucket: "puzzeltocht-maastricht.appspot.com",
        messagingSenderId: "825884044147",
        appId: "1:825884044147:web:f329c4af2373cbedbcb306"
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
      const timerRef = db.ref("timer");
      const tekstRef = db.ref("tekst");

      const urlParams = new URLSearchParams(window.location.search);
      const isDisplayMode = urlParams.get('view') === 'display';

      const timerDisplay = document.getElementById("timer");
      const slider = document.getElementById("timeSlider");

      let totalSeconds = 9000;
      let remaining = totalSeconds;
      let interval = null;
      let isSliding = false;

      function formatTime(secs) {
        const h = String(Math.floor(secs / 3600)).padStart(2, '0');
        const m = String(Math.floor((secs % 3600) / 60)).padStart(2, '0');
        const s = String(secs % 60).padStart(2, '0');
        return `${h}:${m}:${s}`;
      }

      function updateDisplay() {
        if (!timerDisplay) return;
        timerDisplay.textContent = formatTime(remaining);
        if (slider) slider.value = remaining;

        if ([7200, 5400, 3600, 1800].includes(remaining)) {
          timerDisplay.classList.add("flash");
          setTimeout(() => timerDisplay.classList.remove("flash"), 10000);
        }

        if (remaining <= 600 && remaining > 0) {
          const urgencyLevel = 10 - remaining / 60;
          const scale = 1 + urgencyLevel * 0.03;
          const color = `rgb(${100 + urgencyLevel * 15}, 0, 0)`;
          const bgColor = `rgb(${30 + urgencyLevel * 20}, 0, 0)`;

          timerDisplay.classList.add("urgent");
          timerDisplay.style.transform = `scale(${scale})`;
          timerDisplay.style.color = "yellow";
          timerDisplay.style.backgroundColor = bgColor;
          timerDisplay.style.borderColor = color;
        }

        if (remaining <= 0) {
          clearInterval(interval);
          interval = null;
          timerDisplay.classList.remove("urgent");
          timerDisplay.textContent = "TIJD OM!";
          const finalMessage = document.getElementById("finalMessage");
          if (finalMessage) {
            finalMessage.textContent = "";
            finalMessage.style.display = "none";
          }
        }
      }

      function updateFirebase() {
        timerRef.set({ remaining, running: !!interval, timestamp: Date.now() });
      }

      function berekenRemaining(remaining, timestamp) {
        const secondsPassed = Math.floor((Date.now() - timestamp) / 1000);
        return Math.max(0, remaining - secondsPassed);
      }

      timerRef.on("value", (snapshot) => {
        const data = snapshot.val();
        if (!data) return;

        const wasRunning = !!interval;
        remaining = data.running
          ? berekenRemaining(data.remaining, data.timestamp)
          : data.remaining;
        updateDisplay();

        if (data.running && !interval && remaining > 0) {
          interval = setInterval(() => {
            remaining--;
            updateDisplay();
            updateFirebase();
          }, 1000);
        }

        if (!data.running && wasRunning) {
          clearInterval(interval);
          interval = null;
        }
      });

      if (!isDisplayMode) {
        document.getElementById("startBtn").addEventListener("click", () => {
          if (interval) return;
          interval = setInterval(() => {
            if (!isSliding && remaining > 0) {
              remaining--;
              updateDisplay();
              updateFirebase();
            }
          }, 1000);
          updateFirebase();
        });

        document.getElementById("stopBtn").addEventListener("click", () => {
          clearInterval(interval);
          interval = null;
          timerRef.set({ remaining, running: false, timestamp: Date.now() });
        });

        document.getElementById("resetBtn").addEventListener("click", () => {
          clearInterval(interval);
          interval = null;
          remaining = totalSeconds;
          timerDisplay.classList.remove("flash", "urgent");
          timerDisplay.style.borderColor = "white";
          timerDisplay.style.backgroundColor = "#111";
          timerDisplay.style.color = "white";
          timerDisplay.style.transform = "scale(1)";
          updateDisplay();
          updateFirebase();
        });
      }

      if (slider) {
        slider.addEventListener("input", () => {
          isSliding = true;
          remaining = parseInt(slider.value);
          updateDisplay();
        });

        slider.addEventListener("change", () => {
          isSliding = false;
          updateFirebase();
        });
      }

      if (isDisplayMode) {
        const controls = document.querySelector('.controls');
        if (controls) controls.style.display = 'none';
        const tekstControls = document.getElementById('tekstControls');
        if (tekstControls) tekstControls.style.display = 'none';
        if (slider) slider.style.display = 'none';
        const footer = document.querySelector('.footer');
        if (footer) footer.style.display = 'none';
        const header = document.querySelector('h1');
        if (header) header.style.display = 'none';

        if (document.documentElement.requestFullscreen) {
          document.documentElement.requestFullscreen().catch(err => {
            console.warn("Fullscreen niet toegestaan:", err);
          });
        }
      }

      window.stelHandmatigTijdIn = () => {
        const input = document.getElementById("manualTimeInput").value.trim();
        const parts = input.split(":");
        if (parts.length !== 3) {
          alert("Voer een tijd in als hh:mm:ss");
          return;
        }
        const [h, m, s] = parts.map(Number);
        if ([h, m, s].some(isNaN) || h < 0 || m < 0 || s < 0 || m > 59 || s > 59) {
          alert("Ongeldige tijd. Zorg voor hh:mm:ss met geldige getallen.");
          return;
        }
        totalSeconds = h * 3600 + m * 60 + s;
        remaining = totalSeconds;
        updateDisplay();
        updateFirebase();
      };

      window.toonVrijeTekst = () => {
        const tekst = document.getElementById("customTextInput").value.trim();
        if (tekst) {
          tekstRef.set({ inhoud: tekst });
        }
      };

      window.toonGeselecteerdeTekst = () => {
        const nr = parseInt(document.getElementById('tekstSelect').value);
        if (!isNaN(nr)) {
          toonTekst(nr);
        }
      };

      window.verbergTeksten = (verbergEigen = true) => {
        const tekstSelect = document.getElementById('tekstSelect');
        const customTextInput = document.getElementById('customTextInput');
        const vrijeEl = document.getElementById('eigenTekst');

        document.querySelectorAll('.tekst').forEach(el => {
          if (!verbergEigen && el.id === 'eigenTekst') return;
          el.textContent = '';
          el.style.display = 'none';
        });

        if (tekstSelect) tekstSelect.value = "";
        if (customTextInput) customTextInput.value = "";
        if (vrijeEl) vrijeEl.textContent = "";

        tekstRef.set({ inhoud: "" });
      };

      function toonTekst(nr) {
        const teksten = [
          "Welkom bij KDW 25! Veel plezier en succes vandaag!",
          "De volgende opdracht staat voor jullie klaar. Bekijk de aanwijzing goed.",
          "Let op: je kunt nu bonuspunten verdienen met een goede inschatting.",
          "Halverwege! Tijd voor een korte pauze of wisselmoment.",
          "De tijd tikt door – vergeet niet in te leveren voor de deadline.",
          "Jullie hebben nog 30 minuten. Hou het tempo erin!",
          "Laatste 10 minuten – nu telt alles!",
          "Verzamel je team en maak je klaar voor het eindspel.",
          "LET OP: Antwoorden worden niet meer geaccepteerd.",
          "Bedankt voor jullie deelname aan KDW 25!"
        ];
        if (!isNaN(nr) && teksten[nr - 1]) {
          tekstRef.set({ inhoud: teksten[nr - 1] });
        }
      }
    });
  </script>
  <!-- De rest van je HTML en CSS blijft ongewijzigd -->
</head>
<body>
  <!-- Je bestaande body-structuur blijft behouden -->
</body>
</html>
