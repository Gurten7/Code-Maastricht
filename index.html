<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Puzzeltocht Maastricht</title>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  <style>
  body {
    font-family: Arial, sans-serif;
    background-color: #000;
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    min-height: 100vh;
    margin: 0;
    padding: 1em;
    box-sizing: border-box;
    text-align: center;
  }

  #teamLabel {
    font-size: 1.5em;
    margin: 0.3em 0 1em;
    color: orange;
    display: none;
  }

  #timer {
    font-size: clamp(3em, 10vw, 6em);
    padding: 0.5em 1em;
    background: #111;
    border: 5px solid white;
    border-radius: 20px;
    text-align: center;
    margin-bottom: 1em;
    width: 80%;
    max-width: 500px;
  }

  .controls {
    margin-top: 1.5em;
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
  }

  button {
    padding: 0.8em;
    font-size: 1em;
    margin: 6px 0;
    background: red;
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    width: 100%;
    max-width: 280px;
  }

  input[type="text"], select {
    padding: 0.5em;
    font-size: 1em;
    width: 100%;
    max-width: 300px;
    margin: 8px 0;
    box-sizing: border-box;
  }

  #timeSlider {
    width: 100%;
    max-width: 500px;
    margin-top: 1em;
  }

  .flash {
    animation: flash 1s infinite;
  }

  @keyframes flash {
    0%, 100% { background: #111; color: white; }
    50% { background: red; color: black; }
  }

  .urgent {
    animation: urgentFlash 1s infinite;
  }

  @keyframes urgentFlash {
    0%, 100% { background: #111; color: white; }
    50% { background: darkred; color: yellow; transform: scale(1.05); }
  }

.footer {
  position: fixed;
  bottom: 1em;
  right: 1em;
  color: gray;
  font-size: 0.8em;
  background: transparent;
  text-align: right;
  z-index: 10;
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 0.2em;
}

#webdesignLogo {
  height: 60px;
  opacity: 0.95;
  pointer-events: none;
}


  #scoreBoard {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 1em;
    margin: 2em 0;
    width: 100%;
    max-width: 600px;
  }

  .scorecard {
    flex: 1 1 200px;
    max-width: 240px;
    background: #111;
    color: white;
    border: 5px solid white;
    border-radius: 20px;
    font-size: 2em;
    padding: 1em;
    cursor: pointer;
    text-align: center;
  }

  .scorecard .scoreName {
    font-size: 0.7em;
    color: orange;
    display: block;
    margin-bottom: 0.3em;
  }

  .scorecard.selected {
    border-color: orange;
  }

  #scoreControls {
    display: flex;
    justify-content: center;
    gap: 1em;
    flex-wrap: wrap;
    margin-top: 1em;
    width: 100%;
    max-width: 300px;
  }

  #scoreControls .score-btn {
    background: #222;
    color: white;
    border: 2px solid white;
    border-radius: 10px;
    padding: 0.5em;
    font-size: 1em;
    cursor: pointer;
    flex: 1 1 auto;
  }

  #teamUploadIframeSection {
    width: 100%;
    max-width: 800px;
    margin: 2em auto;
  }

  #teamUploadIframeSection iframe {
    width: 100%;
    height: 600px;
    border: none;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(255,255,255,0.2);
  }

  @media (max-width: 767px) {
    #timer {
      font-size: clamp(2.2em, 8vw, 4em);
      padding: 0.3em 0.5em;
      margin-bottom: 0.5em;
    }

    .controls, .tekst-controls {
      max-width: 300px;
      width: 100%;
    }

    button, input[type="text"], select {
      font-size: 0.9em;
      padding: 0.5em;
      margin: 4px 0;
      max-width: 95%;
    }

    #timeSlider {
      margin-top: 0.5em;
      height: 20px;
    }

    .scorecard {
      flex: 1 1 45%;
      max-width: 25%;
    }
  }
</style>
</head>
<body>
<script>
window.addEventListener("DOMContentLoaded", () => {
  const firebaseConfig = {
    apiKey: "AIzaSyA9PTsrTBR7cYf1oAfPtnyF4g9laqkdwng",
    authDomain: "puzzeltocht-maastricht.firebaseapp.com",
    databaseURL: "https://puzzeltocht-maastricht-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "puzzeltocht-maastricht",
    storageBucket: "puzzeltocht-maastricht.appspot.com",
    messagingSenderId: "825884044147",
    appId: "1:825884044147:web:f329c4af2373cbedbcb306"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

  const db = firebase.database();
  const timerRef = db.ref("timer");
  const tekstRef = db.ref("tekst");
  const teamnamenRef = db.ref("teamnamen");
  const scoresRef = db.ref("scores");

  const urlParams = new URLSearchParams(window.location.search);
  const isDisplayMode = urlParams.get("view") === "display";
  const isControlMode = urlParams.get("view") === "edit123";
  const teamCode = urlParams.get("team");
  const allowedTeams = { "37xskp": "Team A", "z8kd01": "Team B" };

  if ((isDisplayMode && !(teamCode in allowedTeams)) || (!isDisplayMode && !isControlMode)) {
    document.body.innerHTML = '<h2 style="color: red; text-align: center; margin-top: 2em;">Toegang geweigerd</h2>';
    return;
  }

  const teamLabel = document.getElementById("teamLabel");
  if (isDisplayMode && teamCode && teamLabel) {
    teamnamenRef.child(teamCode).on("value", (snap) => {
      teamLabel.textContent = snap.val() || "Team onbekend";
      teamLabel.style.display = "block";
    });
  }

  if (isControlMode) {
    const inputA = document.getElementById("inputTeamA");
    const inputB = document.getElementById("inputTeamB");
    const knop = document.getElementById("opslaanTeamnamen");

    if (inputA && inputB && knop) {
      knop.addEventListener("click", () => {
        teamnamenRef.set({ "37xskp": inputA.value.trim(), "z8kd01": inputB.value.trim() });
      });
      teamnamenRef.once("value", (snap) => {
        const data = snap.val() || {};
        inputA.value = data["37xskp"] || "";
        inputB.value = data["z8kd01"] || "";
      });
    }
  }

  teamnamenRef.on("value", (snap) => {
    const data = snap.val() || {};
    const scoreNameA = document.getElementById("scoreNameA");
    const scoreNameB = document.getElementById("scoreNameB");
    if (scoreNameA) scoreNameA.textContent = data["37xskp"] || "Team A";
    if (scoreNameB) scoreNameB.textContent = data["z8kd01"] || "Team B";
  });
  // === TIMER ===
  const timerDisplay = document.getElementById("timer");
  const slider = document.getElementById("timeSlider");
  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");
  const resetBtn = document.getElementById("resetBtn");
  const manualInput = document.getElementById("manualTimeInput");

  let totalSeconds = 9000;
  let remaining = totalSeconds;
  let interval = null;
  let isSliding = false;

  function formatTime(secs) {
    const h = String(Math.floor(secs / 3600)).padStart(2, '0');
    const m = String(Math.floor((secs % 3600) / 60)).padStart(2, '0');
    const s = String(secs % 60).padStart(2, '0');
    return `${h}:${m}:${s}`;
  }

  function updateDisplay() {
    if (timerDisplay && slider) {
      timerDisplay.textContent = remaining > 0 ? formatTime(remaining) : "TIJD OM!";
      slider.value = remaining;
      timerDisplay.classList.remove("flash", "urgent");
      timerDisplay.style.borderColor = "white";
      timerDisplay.style.backgroundColor = "#111";
      timerDisplay.style.color = "white";
      timerDisplay.style.transform = "scale(1)";
      if ([7200, 5400, 3600, 1800].includes(remaining)) {
        timerDisplay.classList.add("flash");
        setTimeout(() => timerDisplay.classList.remove("flash"), 10000);
      }
      if (remaining > 0 && remaining <= 600) {
        const urgencyLevel = 10 - Math.floor(remaining / 60);
        const scale = 1 + urgencyLevel * 0.03;
        const color = `rgb(${100 + urgencyLevel * 15}, 0, 0)`;
        const bgColor = `rgb(${30 + urgencyLevel * 20}, 0, 0)`;
        timerDisplay.classList.add("urgent");
        timerDisplay.style.transform = `scale(${scale})`;
        timerDisplay.style.color = "yellow";
        timerDisplay.style.backgroundColor = bgColor;
        timerDisplay.style.borderColor = color;
      }
    }
  }

  function updateFirebase(running) {
    timerRef.set({ remaining, running, timestamp: Date.now() });
  }

  function calcRemaining(rem, timestamp) {
    const passed = Math.floor((Date.now() - timestamp) / 1000);
    return Math.max(0, rem - passed);
  }

  timerRef.on("value", (snapshot) => {
    const data = snapshot.val();
    if (!data) return;
    const wasRunning = !!interval;
    remaining = data.running ? calcRemaining(data.remaining, data.timestamp) : data.remaining;
    updateDisplay();

    if (data.running && remaining > 0) {
      if (interval) clearInterval(interval);
      interval = setInterval(() => {
        if (!isSliding && remaining > 0) {
          remaining--;
          updateDisplay();
          updateFirebase(true);
        }
      }, 1000);
    }

    if (!data.running && wasRunning) {
      clearInterval(interval);
      interval = null;
    }
  });

  startBtn?.addEventListener("click", () => {
    if (remaining > 0) updateFirebase(true);
  });

  stopBtn?.addEventListener("click", () => {
    clearInterval(interval);
    interval = null;
    updateFirebase(false);
  });

  resetBtn?.addEventListener("click", () => {
    clearInterval(interval);
    interval = null;
    remaining = totalSeconds;
    updateDisplay();
    updateFirebase(false);
  });

  slider?.addEventListener("input", () => {
    isSliding = true;
    remaining = parseInt(slider.value);
    updateDisplay();
  });

  slider?.addEventListener("change", () => {
    isSliding = false;
    updateFirebase(!!interval);
  });

  window.stelHandmatigTijdIn = () => {
    if (!manualInput) return;
    const parts = manualInput.value.trim().split(":").map(Number);
    if (parts.length !== 3 || parts.some(isNaN)) {
      alert("Gebruik het formaat hh:mm:ss");
      return;
    }
    const [h, m, s] = parts;
    const nieuweTijd = h * 3600 + m * 60 + s;
    if (nieuweTijd > 9000) {
      alert("Maximale tijd is 2:30:00 (9000 sec)");
      return;
    }
    remaining = nieuweTijd;
    updateDisplay();
    updateFirebase(!!interval);
  };

  // === SCOREBORD ===
  const scoreCardA = document.getElementById("scoreCardA");
  const scoreCardB = document.getElementById("scoreCardB");
  const scoreValueA = document.getElementById("scoreValueA");
  const scoreValueB = document.getElementById("scoreValueB");
  const scoreControls = document.getElementById("scoreControls");

  let geselecteerdScoreCard = null;

  if (isControlMode && scoreControls) {
    scoreControls.style.display = "flex";

    function updateSelectedCard(card) {
      scoreCardA?.classList.remove("selected");
      scoreCardB?.classList.remove("selected");
      geselecteerdScoreCard = card;
      card.classList.add("selected");
    }

    scoreCardA?.addEventListener("click", () => updateSelectedCard(scoreCardA));
    scoreCardB?.addEventListener("click", () => updateSelectedCard(scoreCardB));

    document.getElementById("scorePlus1")?.addEventListener("click", () => wijzigScore(1));
    document.getElementById("scorePlus2")?.addEventListener("click", () => wijzigScore(2));
    document.getElementById("scoreMinus1")?.addEventListener("click", () => wijzigScore(-1));

    function wijzigScore(delta) {
      if (!geselecteerdScoreCard) return;
      const teamKey = geselecteerdScoreCard === scoreCardA ? "37xskp" : "z8kd01";
      scoresRef.child(teamKey).once("value", (snapshot) => {
        const huidigeScore = snapshot.val() || 0;
        scoresRef.child(teamKey).set(huidigeScore + delta);
      });
    }
  }

  scoresRef.on("value", (snapshot) => {
    const data = snapshot.val() || {};
    if (scoreValueA) scoreValueA.textContent = data["37xskp"] ?? 0;
    if (scoreValueB) scoreValueB.textContent = data["z8kd01"] ?? 0;
  });
  // === TEKSTEN ===
  const standaardTeksten = [
    "Welkom bij KDW 25! Veel plezier en succes vandaag!",
    "De volgende opdracht staat voor jullie klaar. Bekijk de aanwijzing goed.",
    "Let op: je kunt nu bonuspunten verdienen met een goede inschatting.",
    "Halverwege! Tijd voor een korte pauze of wisselmoment.",
    "De tijd tikt door – vergeet niet in te leveren voor de deadline.",
    "Jullie hebben nog 30 minuten. Hou het tempo erin!",
    "Laatste 10 minuten – nu telt alles!",
    "Verzamel je team en maak je klaar voor het eindspel.",
    "LET OP: Antwoorden worden niet meer geaccepteerd.",
    "Bedankt voor jullie deelname aan KDW 25!"
  ];

  tekstRef.on("value", (snapshot) => {
    const tekst = snapshot.val()?.inhoud || "";
    document.querySelectorAll(".tekst").forEach(el => {
      el.style.display = "none";
      el.textContent = "";
    });
    const index = standaardTeksten.indexOf(tekst);
    const id = index >= 0 ? `tekst${index + 1}` : "eigenTekst";
    const target = document.getElementById(id);
    if (target) {
      target.textContent = tekst;
      target.style.display = "block";
    }
  });

  window.toonVrijeTekst = () => {
    const input = document.getElementById("customTextInput");
    if (!input) return;
    const tekst = input.value.trim();
    tekstRef.set({ inhoud: tekst });
  };

  window.toonGeselecteerdeTekst = () => {
    const select = document.getElementById("tekstSelect");
    const index = parseInt(select.value);
    if (!isNaN(index) && index >= 1 && index <= 10) {
      tekstRef.set({ inhoud: standaardTeksten[index - 1] });
    }
  };

  window.verbergTeksten = () => {
    tekstRef.set({ inhoud: "" });
  };

  // === UI AANPASSINGEN ===
  const controlsDiv = document.querySelector(".controls");
  const tekstControls = document.getElementById("tekstControls");
  const logo = document.getElementById("logo");
  const title = document.getElementById("pageTitle");
  const teamUploadIframeSection = document.getElementById("teamUploadIframeSection");

  if (controlsDiv) controlsDiv.style.display = isDisplayMode ? "none" : "flex";
  if (tekstControls) tekstControls.style.display = isDisplayMode ? "none" : "block";
  if (slider) slider.style.display = isDisplayMode ? "none" : "block";
  if (logo) logo.style.display = isDisplayMode ? "block" : "none";
  if (title) title.style.display = isDisplayMode ? "block" : "none";

  // === JOTFORM IFRAME INVOEGEN PER TEAM ===
  const teamFormUrls = {
    "37xskp": "https://form.jotform.com/250903000714341",
    "z8kd01": "https://form.jotform.com/250901825652052"
  };

  if (isDisplayMode && teamCode && teamFormUrls[teamCode] && teamUploadIframeSection) {
    const iframe = document.createElement("iframe");
    iframe.id = "JotFormIFrame-" + teamCode;
    iframe.title = "Upload hier jullie foto's";
    iframe.allowTransparency = true;
    iframe.allow = "geolocation; microphone; camera; fullscreen";
    iframe.src = teamFormUrls[teamCode] + "?teamnaam=" + encodeURIComponent(allowedTeams[teamCode]);
    iframe.style = "min-width:100%;max-width:100%;height:800px;border:none;border-radius:10px;";
    iframe.scrolling = "no";

    teamUploadIframeSection.appendChild(iframe);
    teamUploadIframeSection.style.display = "block";

    const script = document.createElement("script");
    script.src = "https://cdn.jotfor.ms/s/umd/latest/for-form-embed-handler.js";
    document.body.appendChild(script);
  }
});
</script>
</div>
  <div class="footer">
    <span>© Geerten Liesker</span>
    <img id="webdesignLogo" src="geerten-webdesign.png" alt="Geerten Webdesign Logo" />
  </div>
  <img id="logo" src="KDW25.png" alt="KDW 25 Logo" style="display: none; position: relative; margin: 2em auto 0 auto; height: clamp(150px, 30vw, 280px); opacity: 0.95; pointer-events: none;" />
</body>
</html>
